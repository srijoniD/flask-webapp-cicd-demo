- name: Deploy Flask App to EKS
  hosts: localhost
  gather_facts: false
  vars:
    region: "{{ lookup('env','AWS_DEFAULT_REGION') | default('us-east-1') }}"
    kubeconfig: "{{ lookup('env','HOME') + '/.kube/config' }}"
    workspace: "{{ lookup('env','WORKSPACE') }}"
  tasks:
    - name: Show AWS identity inside Ansible
      command: aws sts get-caller-identity
      register: whoami
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"
        AWS_DEFAULT_REGION: "{{ region }}"
    - debug:
        var: whoami.stdout

    - name: Update kubeconfig for EKS (write to jenkins HOME)
      command: aws eks update-kubeconfig --name flask-eks --region {{ region }} --kubeconfig {{ kubeconfig }}
      environment:
        AWS_ACCESS_KEY_ID: "{{ lookup('env','AWS_ACCESS_KEY_ID') }}"
        AWS_SECRET_ACCESS_KEY: "{{ lookup('env','AWS_SECRET_ACCESS_KEY') }}"
        AWS_DEFAULT_REGION: "{{ region }}"

    - name: Kubectl sanity â€“ current context
      command: kubectl config current-context
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Kubectl RBAC check
      command: kubectl auth can-i get pods --all-namespaces
      environment:
        KUBECONFIG: "{{ kubeconfig }}"

    - name: Apply manifests from Jenkins workspace (skip OpenAPI validation)
      command: kubectl apply -f {{ workspace }}/k8s/ --validate=false
      environment:
        KUBECONFIG: "{{ kubeconfig }}"
